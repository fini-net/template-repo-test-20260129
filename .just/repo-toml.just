# .just/repo-toml.just
# Repository metadata extraction and shell variable generation

# generate shell variables from .repo.toml
[group('Testing/Automation')]
repo_toml_generate:
    #!/usr/bin/env bash
    set -euo pipefail

    # Validate .repo.toml exists and passes cue validation
    if [[ ! -f .repo.toml ]]; then
        echo "{{RED}}Error: .repo.toml not found{{NORMAL}}"
        exit 1
    fi

    if ! cue vet docs/repo-toml.cue .repo.toml >/dev/null 2>&1; then
        echo "{{RED}}Error: .repo.toml failed cue validation{{NORMAL}}"
        cue vet docs/repo-toml.cue .repo.toml
        exit 1
    fi

    # Export JSON once
    JSON=$(cue export .repo.toml)

    # Extract all fields with safe defaults
    DESCRIPTION=$(echo "$JSON" | jq -r '.about.description // ""')
    LICENSE=$(echo "$JSON" | jq -r '.about.license // ""')
    TOPICS_JSON=$(echo "$JSON" | jq -r '.about.topics // []')
    TOPICS_ARRAY=$(echo "$TOPICS_JSON" | jq -r '.[]' | sort)
    TOPICS_CSV=$(echo "$TOPICS_ARRAY" | paste -sd ',' -)

    GIT_SSH=$(echo "$JSON" | jq -r '.urls.git_ssh // ""')
    WEB_URL=$(echo "$JSON" | jq -r '.urls.web_url // ""')

    # Derive org and repo name from web URL
    # Example: https://github.com/fini-net/template-repo -> fini-net, template-repo
    ORG_NAME=$(echo "$WEB_URL" | sed -E 's|https://github.com/([^/]+)/.*|\1|')
    REPO_NAME=$(echo "$WEB_URL" | sed -E 's|https://github.com/[^/]+/(.+)|\1|')

    # Validate URL parsing succeeded
    if [[ -z "$ORG_NAME" ]] || [[ -z "$REPO_NAME" ]]; then
        echo "{{RED}}Error: Failed to parse organization and repository name from web_url{{NORMAL}}"
        echo "{{YELLOW}}Expected format: https://github.com/org-name/repo-name{{NORMAL}}"
        echo "{{YELLOW}}Got: $WEB_URL{{NORMAL}}"
        exit 1
    fi

    # Extract feature flags as strings ("true" or "false")
    FLAG_CLAUDE=$(echo "$JSON" | jq -r 'if .flags.claude == true then "true" else "false" end')
    FLAG_CLAUDE_REVIEW=$(echo "$JSON" | jq -r 'if .flags["claude-review"] == true then "true" else "false" end')
    FLAG_COPILOT_REVIEW=$(echo "$JSON" | jq -r 'if .flags["copilot-review"] == true then "true" else "false" end')
    FLAG_STANDARD_RELEASE=$(echo "$JSON" | jq -r 'if .flags["standard-release"] == false then "false" else "true" end')

    # Generate .just/repo-toml.sh with all content
    {
        echo "# Auto-generated from .repo.toml by 'just repo_toml_generate'"
        echo "# DO NOT EDIT THIS FILE MANUALLY - regenerate with: just repo_toml_generate"
        echo ""
        echo "# About section"
        echo "REPO_DESCRIPTION=\"${DESCRIPTION}\""
        echo "REPO_LICENSE=\"${LICENSE}\""
        echo "REPO_TOPICS=\"${TOPICS_CSV}\""
        echo ""
        echo "# URLs section"
        echo "REPO_GIT_SSH=\"${GIT_SSH}\""
        echo "REPO_WEB_URL=\"${WEB_URL}\""
        echo ""
        echo "# Derived values"
        echo "REPO_ORG_NAME=\"${ORG_NAME}\""
        echo "REPO_REPO_NAME=\"${REPO_NAME}\""
        echo ""
        echo "# Feature flags (strings: \"true\" or \"false\")"
        echo "FLAG_CLAUDE=\"${FLAG_CLAUDE}\""
        echo "FLAG_CLAUDE_REVIEW=\"${FLAG_CLAUDE_REVIEW}\""
        echo "FLAG_COPILOT_REVIEW=\"${FLAG_COPILOT_REVIEW}\""
        echo "FLAG_STANDARD_RELEASE=\"${FLAG_STANDARD_RELEASE}\""
        echo ""
        echo "# Topics as array (for iteration)"
        echo "REPO_TOPICS_ARRAY=("
        echo "$TOPICS_ARRAY" | while IFS= read -r topic; do
            if [[ -n "$topic" ]]; then
                echo "    \"$topic\""
            fi
        done
        echo ")"
    } > .just/repo-toml.sh

    echo "{{GREEN}}Generated .just/repo-toml.sh{{NORMAL}}"
    echo "{{BLUE}}Org: $ORG_NAME, Repo: $REPO_NAME{{NORMAL}}"
    echo "{{BLUE}}Flags - Claude: $FLAG_CLAUDE, Claude Review: $FLAG_CLAUDE_REVIEW, Copilot Review: $FLAG_COPILOT_REVIEW, Standard Release: $FLAG_STANDARD_RELEASE{{NORMAL}}"

# check if generated shell file is up-to-date
[group('Testing/Automation')]
repo_toml_check:
    #!/usr/bin/env bash
    set -euo pipefail

    # Verify .just/repo-toml.sh exists
    if [[ ! -f .just/repo-toml.sh ]]; then
        echo "{{YELLOW}}Warning: .just/repo-toml.sh not found{{NORMAL}}"
        echo "{{BLUE}}Run 'just repo_toml_generate' to create it{{NORMAL}}"
        exit 1
    fi

    # Check if .repo.toml is newer (staleness detection)
    if [[ .repo.toml -nt .just/repo-toml.sh ]]; then
        echo "{{YELLOW}}Warning: .just/repo-toml.sh is stale{{NORMAL}}"
        echo "{{BLUE}}.repo.toml has been modified since last generation{{NORMAL}}"
        echo "{{BLUE}}Run 'just repo_toml_generate' to regenerate{{NORMAL}}"
        exit 1
    fi

    echo "{{GREEN}}.just/repo-toml.sh is up-to-date{{NORMAL}}"
